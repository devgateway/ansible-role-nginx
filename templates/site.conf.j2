{%  import 'libnginx.j2' as ngx with context -%}
{%  import 'libsite.j2' as libsite with context -%}

{{  ngx.bulk_directives( site.http | default({})) }}
{{  '\n' }}

{%- for _map in site.http.maps | default([]) %}
{{    libsite.map_block(_map) ~ '\n' }}
{%  endfor -%}

{%- if site.redirect_from is defined %}
{%    for ssl in [false, site.server.ssl | default(true)] | unique %}
{{      ('Redirect to the primary domain, ' ~ ssl | ternary('SSL', 'plain')) | comment }}
{%      set content %}
{{        ngx.directive('listen', ssl | ternary(443, 80)) }}
{{        ngx.directive('server_name', site.redirect_from) }}
{%        if ssl %}
{{          ngx.directive('ssl', true) }}
{%        endif %}
{{        libsite.redirect(host = libsite.primary_name(), ssl = true) }}
{%-     endset %}
{{      ngx.block('server', content) ~ '\n' }}
{%    endfor %}
{%  endif -%}

{%- if site.server.ssl | default(true) %}
{{    'Redirect from non-SSL to SSL' | comment }}
{%    set content %}
{{      ngx.directive('listen', 80) }}
{{      ngx.directive('server_name', site.server.server_name) }}
{{      libsite.redirect(host = libsite.primary_name(), ssl = true) }}
{%-   endset %}
{{    ngx.block('server', content) ~ '\n' }}
{%  endif -%}

{%- set content %}
{{    ngx.bulk_directives(site.server | default({})) }}
{%-   for if_block in site.server.ifs | default([]) %}
{{      '\n' }}
{{      ngx.block(['if', '(%s)' | format(if_block.if)], ngx.bulk_directives(if_block)) }}
{%-   endfor %}
{%-   for location in site.server.locations | default([]) %}
{{      '\n' }}
{{      libsite.locations(location) }}
{%-   endfor %}
{%  endset -%}

{{  ngx.block('server', content) }}
