{% macro directive(directive, my_args = [], my_kwargs = {}) %}
{% if my_args is string or my_args is not sequence %}
{% set my_args = [my_args] %}
{% endif %}
{{ directive }}
{%- for arg in my_args %}
{% if arg is sameas true %}
{% set arg = 'on' %}
{% elif arg is sameas false %}
{% set arg = 'off' %}
{% else %}
{% if arg is string and ' ' in arg %}
{% set arg = arg | quote %}
{% endif %}
{% endif %}
 {{ arg }}
{%- endfor %}
{% for key, val in my_kwargs | dictsort %}
{%- if val is sameas true %}
 {{ key }}
{%- elif val is sameas false %}
{%- else %}
 {{ key }}={{ val }}
{%- endif %}
{%- endfor %}
;
{%- endmacro -%}

{% macro block(block_name, content = none) %}
{% if block_name is string -%}
  {{ block_name }}
{%- else -%}
  {{ block_name | select | join(' ') }}
{%- endif -%}
{{ ' ' }}{
{% if content %}
{% filter indent(first = true) %}
{{ content }}
{% endfilter %}
{% endif %}
}
{%- endmacro -%}

{% macro location(expr, operator = '', content = none) %}
{{  block(
      block_name = ['location', operator, expr],
      content = content
    )
}}
{%- endmacro -%}

{% macro redirect(host, ssl = true, permanent = true, uri = '$request_uri') %}
{{  directive(
      'return',
      [
        permanent | ternary(301, 302),
        (ssl | ternary('https', 'http')) ~ '://' ~ host ~ uri
      ]
    )
}}
{%- endmacro -%}
